<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>A Monte Carlo Simulation Workflow in Python | Yiming Paul Li</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="A Monte Carlo Simulation Workflow in Python" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Keep parameters, simulated datasets, summary stats, and models in one place." />
<meta property="og:description" content="Keep parameters, simulated datasets, summary stats, and models in one place." />
<link rel="canonical" href="https://yimingli.net/a-monte-carlo-simulation-workflow-in-python.html" />
<meta property="og:url" content="https://yimingli.net/a-monte-carlo-simulation-workflow-in-python.html" />
<meta property="og:site_name" content="Yiming Paul Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-27T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://yimingli.net/a-monte-carlo-simulation-workflow-in-python.html","@type":"BlogPosting","headline":"A Monte Carlo Simulation Workflow in Python","dateModified":"2020-11-27T00:00:00-06:00","datePublished":"2020-11-27T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://yimingli.net/a-monte-carlo-simulation-workflow-in-python.html"},"description":"Keep parameters, simulated datasets, summary stats, and models in one place.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://yimingli.net/feed.xml" title="Yiming Paul Li" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49350925-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Yiming Paul Li</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">A Monte Carlo Simulation Workflow in Python</h1><p class="page-description">Keep parameters, simulated datasets, summary stats, and models in one place.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-11-27T00:00:00-06:00" itemprop="datePublished">
        Nov 27, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#python">python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#simulation">simulation</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#workflow">workflow</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/yimingli/blog/tree/master/_notebooks/2020-11-27-a-monte-carlo-simulation-workflow-in-python.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/yimingli/blog/master?filepath=_notebooks%2F2020-11-27-a-monte-carlo-simulation-workflow-in-python.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/yimingli/blog/blob/master/_notebooks/2020-11-27-a-monte-carlo-simulation-workflow-in-python.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Introduction">Introduction </a></li>
<li class="toc-entry toc-h2"><a href="#Set-model-parameters">Set model parameters </a></li>
<li class="toc-entry toc-h2"><a href="#Simulate-datasets">Simulate datasets </a></li>
<li class="toc-entry toc-h2"><a href="#Do-stuff-with-the-simulated-datasets">Do stuff with the simulated datasets </a></li>
<li class="toc-entry toc-h2"><a href="#Keep-everything-in-a-dataframe">Keep everything in a dataframe </a></li>
<li class="toc-entry toc-h2"><a href="#Parallel-computation">Parallel computation </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-11-27-a-monte-carlo-simulation-workflow-in-python.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h2>
<p>This is a workflow for Monte Carlo Simulation in Python, using a dataframe to track the parameters, simulated dataset, and summary statistics / model fitting. For multi-core machines, we can try to speed up using parallel computation.</p>
<p>This workflow is inspired by R's <code>purrr</code> package and the notion of <a href="https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html">list-columns</a>. I also benefited from Alex Hayes' <a href="https://www.alexpghayes.com/blog/many-models-workflows-in-python-part-i/">great note on many models workflow in python</a>.</p>
<p><strong>Running example in this note</strong>:</p>
<ol>
<li>Simulate many of datasets from each of the 9 normal distribution, with 3 different centers and 3 different scales.</li>
<li>Calculate the sample statistics for each of the simulated datasets.</li>
<li>Put everything in a dataframe.</li>
</ol>
<p><strong>The workflow consists of 4 steps</strong>:</p>
<ol>
<li>Set the model parameters</li>
<li>Simulate datasets according to the parameters</li>
<li>Do stuff with the simulated datasets, e.g., calculate sample statistics, fit models.</li>
<li>Collect steps 1--3 in a dataframe. The main benefit of keeping everything in a dataframe is for later analysis and visualization of the Monte Carlo simulation.</li>
</ol>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">python_version</span>

<span class="nb">print</span><span class="p">(</span><span class="n">python_version</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>3.7.8
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">psutil</span>

<span class="n">n_cores</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
<span class="n">n_cores</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>16</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Set-model-parameters">
<a class="anchor" href="#Set-model-parameters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set model parameters<a class="anchor-link" href="#Set-model-parameters"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">N_REP</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="c1"># sample size can also be a parameter of simulation, but set to 1 value for illustration</span>
<span class="n">SAMPLE_SIZE</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10_000</span><span class="p">]</span>
<span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_REP</span><span class="p">),</span> <span class="n">SAMPLE_SIZE</span><span class="p">)),</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">,</span> <span class="s2">"scale"</span><span class="p">,</span> <span class="s2">"rep"</span><span class="p">,</span> <span class="s2">"size"</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">params</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loc</th>
      <th>scale</th>
      <th>rep</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8995</th>
      <td>2</td>
      <td>3</td>
      <td>995</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>8996</th>
      <td>2</td>
      <td>3</td>
      <td>996</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>8997</th>
      <td>2</td>
      <td>3</td>
      <td>997</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>8998</th>
      <td>2</td>
      <td>3</td>
      <td>998</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>8999</th>
      <td>2</td>
      <td>3</td>
      <td>999</td>
      <td>10000</td>
    </tr>
  </tbody>
</table>
<p>9000 rows × 4 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simulate-datasets">
<a class="anchor" href="#Simulate-datasets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Simulate datasets<a class="anchor-link" href="#Simulate-datasets"> </a>
</h2>
<p>For small dataset, we can keep the simulated data sets in the tracking dataframe. If the simulated dataset is large, we only keep the sample statistics in the dataframe.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">simulate_data_seq</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>

    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">sim_data</span><span class="p">[</span><span class="s2">"sample"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">"scale"</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">"size"</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">sim_data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sim_data_seq</span> <span class="o">=</span> <span class="n">simulate_data_seq</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 1.34 s, sys: 177 ms, total: 1.51 s
Wall time: 1.52 s
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Do-stuff-with-the-simulated-datasets">
<a class="anchor" href="#Do-stuff-with-the-simulated-datasets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Do stuff with the simulated datasets<a class="anchor-link" href="#Do-stuff-with-the-simulated-datasets"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calculate_sample_stats</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">"""calculate sample statistics"""</span>
    <span class="n">average</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p05</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">p95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">"average"</span><span class="p">:</span> <span class="n">average</span><span class="p">,</span>
        <span class="s2">"variance"</span><span class="p">:</span> <span class="n">variance</span><span class="p">,</span>
        <span class="s2">"p05"</span><span class="p">:</span> <span class="n">p05</span><span class="p">,</span>
        <span class="s2">"p95"</span><span class="p">:</span> <span class="n">p95</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">compute_seq</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_sample_stats</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">"sample"</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sample_stats_seq</span> <span class="o">=</span> <span class="n">compute_seq</span><span class="p">(</span><span class="n">sim_data_seq</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 3.32 s, sys: 12.3 ms, total: 3.34 s
Wall time: 3.34 s
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Keep-everything-in-a-dataframe">
<a class="anchor" href="#Keep-everything-in-a-dataframe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Keep everything in a dataframe<a class="anchor-link" href="#Keep-everything-in-a-dataframe"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">params</span><span class="p">,</span> <span class="n">sim_data_seq</span><span class="p">,</span> <span class="n">sample_stats_seq</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loc</th>
      <th>scale</th>
      <th>rep</th>
      <th>size</th>
      <th>sample</th>
      <th>average</th>
      <th>variance</th>
      <th>p05</th>
      <th>p95</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>10000</td>
      <td>[0.319077282511964, 0.18965678964333085, -0.63...</td>
      <td>-0.018138</td>
      <td>1.000294</td>
      <td>-1.665284</td>
      <td>1.624925</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>10000</td>
      <td>[1.0530038923608775, 0.6534644477062702, 1.385...</td>
      <td>-0.006782</td>
      <td>1.008830</td>
      <td>-1.632020</td>
      <td>1.693900</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>10000</td>
      <td>[0.619682511046317, 0.8076221364639493, -0.212...</td>
      <td>-0.003659</td>
      <td>0.977135</td>
      <td>-1.634407</td>
      <td>1.627604</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>10000</td>
      <td>[-0.7515129763643353, -0.8428228923508118, -0....</td>
      <td>0.007276</td>
      <td>0.994398</td>
      <td>-1.652222</td>
      <td>1.654156</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>10000</td>
      <td>[-0.3187877346174399, -0.09063484844832305, -0...</td>
      <td>0.001544</td>
      <td>1.005466</td>
      <td>-1.639467</td>
      <td>1.663695</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8995</th>
      <td>2</td>
      <td>3</td>
      <td>995</td>
      <td>10000</td>
      <td>[4.459473155059797, 7.17871505746818, 2.080059...</td>
      <td>1.981215</td>
      <td>9.112403</td>
      <td>-3.050421</td>
      <td>6.898461</td>
    </tr>
    <tr>
      <th>8996</th>
      <td>2</td>
      <td>3</td>
      <td>996</td>
      <td>10000</td>
      <td>[1.3252498963188968, -7.932355926994303, 5.374...</td>
      <td>1.984005</td>
      <td>8.874890</td>
      <td>-3.008920</td>
      <td>6.929186</td>
    </tr>
    <tr>
      <th>8997</th>
      <td>2</td>
      <td>3</td>
      <td>997</td>
      <td>10000</td>
      <td>[-5.566903275579494, 4.783448759876334, -1.454...</td>
      <td>1.999839</td>
      <td>8.816550</td>
      <td>-2.910886</td>
      <td>6.922024</td>
    </tr>
    <tr>
      <th>8998</th>
      <td>2</td>
      <td>3</td>
      <td>998</td>
      <td>10000</td>
      <td>[4.783361765266323, 0.06270761044701434, 6.484...</td>
      <td>2.014064</td>
      <td>8.844529</td>
      <td>-2.876956</td>
      <td>6.945541</td>
    </tr>
    <tr>
      <th>8999</th>
      <td>2</td>
      <td>3</td>
      <td>999</td>
      <td>10000</td>
      <td>[3.597228274125008, 1.7495518614255168, 6.9812...</td>
      <td>1.958327</td>
      <td>8.951227</td>
      <td>-2.915028</td>
      <td>6.874206</td>
    </tr>
  </tbody>
</table>
<p>9000 rows × 9 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parallel-computation">
<a class="anchor" href="#Parallel-computation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Parallel computation<a class="anchor-link" href="#Parallel-computation"> </a>
</h2>
<p>We may be able to speed up the simulation and computation using parallel computation, e.g., multiprocessing, multithreading, or other packages, depending on whether the bottlenecks are the I/O, memory, cache, or CPU.</p>
<p>Below is an example of multiprocessing. A few notes when using multiprocessing in Python.</p>
<ul>
<li>Depending on the size of the datasets, number of datasets, and how cpu-hungry the computations are, multiprocessing may not perform better than sequential processing. In my working example, multiprocessing did not improve performance. In my real simulation work with heavier computations, multiprocessing does help.</li>
<li>We need to change the simulation function a little in terms how it takes in arguments, to facilitate the <code>map</code> function.</li>
<li>Chunksize may be a factor for performance.</li>
<li>
<code>Numpy</code>, <code>Scipy</code>, and <code>Pandas</code> scientific computing packages may not play well with multiprocessing. Read more <a href="https://stackoverflow.com/a/15641148/3101585">here</a>.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">CHUNKSIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_cores</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">CHUNKSIZE</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1125</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">simulate_data</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">]</span>  <span class="c1"># float</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">"scale"</span><span class="p">]</span>  <span class="c1"># float</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">"size"</span><span class="p">]</span>  <span class="c1"># int</span>

    <span class="c1"># be sure to reseed the RNG</span>
    <span class="c1"># see discussions here: https://github.com/numpy/numpy/issues/9650</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">simulate_data_mp</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>

    <span class="n">params_list</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">"records"</span><span class="p">)</span>
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">sim_data</span><span class="p">[</span><span class="s2">"sample"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simulate_data</span><span class="p">,</span> <span class="n">params_list</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">CHUNKSIZE</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">sim_data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sim_data_mp</span> <span class="o">=</span> <span class="n">simulate_data_mp</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 619 ms, sys: 4.15 s, total: 4.77 s
Wall time: 6.22 s
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">compute_mp</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">sample_stats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculate_sample_stats</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">"sample"</span><span class="p">],</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">CHUNKSIZE</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sample_stats_mp</span> <span class="o">=</span> <span class="n">compute_mp</span><span class="p">(</span><span class="n">sim_data_seq</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 403 ms, sys: 683 ms, total: 1.09 s
Wall time: 5.13 s
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="yimingli/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/a-monte-carlo-simulation-workflow-in-python.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Some random notes.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://twitter.com/paulymli" title="paulymli"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
