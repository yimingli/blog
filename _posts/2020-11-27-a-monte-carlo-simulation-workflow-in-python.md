---
keywords: fastai
description: "Keep parameters, simulated datasets, summary stats, and models in one place."
title: "A Monte Carlo Simulation Workflow in Python"
toc: true
branch: master
badges: true
comments: true
categories: [python, simulation, workflow]
hide: false
nb_path: _notebooks/2020-11-27-a-monte-carlo-simulation-workflow-in-python.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-11-27-a-monte-carlo-simulation-workflow-in-python.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">Introduction<a class="anchor-link" href="#Introduction"> </a></h2><p>This is a workflow for Monte Carlo Simulation in Python, using a dataframe to track the parameters, simulated dataset, and summary statistics / model fitting. For multi-core machines, we can try to speed up using parallel computation.</p>
<p>This workflow is inspired by R's <code>purrr</code> package and the notion of <a href="https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html">list-columns</a>. I also benefited from Alex Hayes' <a href="https://www.alexpghayes.com/blog/many-models-workflows-in-python-part-i/">great note on many models workflow in python</a>.</p>
<p><strong>Running example in this note</strong>:</p>
<ol>
<li>Simulate many of datasets from each of the 9 normal distribution, with 3 different centers and 3 different scales.</li>
<li>Calculate the sample statistics for each of the simulated datasets.</li>
<li>Put everything in a dataframe.</li>
</ol>
<p><strong>The workflow consists of 4 steps</strong>:</p>
<ol>
<li>Set the model parameters</li>
<li>Simulate datasets according to the parameters</li>
<li>Do stuff with the simulated datasets, e.g., calculate sample statistics, fit models.</li>
<li>Collect steps 1--3 in a dataframe. The main benefit of keeping everything in a dataframe is for later analysis and visualization of the Monte Carlo simulation.</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">python_version</span>

<span class="nb">print</span><span class="p">(</span><span class="n">python_version</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>3.7.8
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">psutil</span>

<span class="n">n_cores</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
<span class="n">n_cores</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>16</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Set-model-parameters">Set model parameters<a class="anchor-link" href="#Set-model-parameters"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">N_REP</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="c1"># sample size can also be a parameter of simulation, but set to 1 value for illustration</span>
<span class="n">SAMPLE_SIZE</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10_000</span><span class="p">]</span>
<span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_REP</span><span class="p">),</span> <span class="n">SAMPLE_SIZE</span><span class="p">)),</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;rep&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">params</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loc</th>
      <th>scale</th>
      <th>rep</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8995</th>
      <td>2</td>
      <td>3</td>
      <td>995</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>8996</th>
      <td>2</td>
      <td>3</td>
      <td>996</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>8997</th>
      <td>2</td>
      <td>3</td>
      <td>997</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>8998</th>
      <td>2</td>
      <td>3</td>
      <td>998</td>
      <td>10000</td>
    </tr>
    <tr>
      <th>8999</th>
      <td>2</td>
      <td>3</td>
      <td>999</td>
      <td>10000</td>
    </tr>
  </tbody>
</table>
<p>9000 rows × 4 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simulate-datasets">Simulate datasets<a class="anchor-link" href="#Simulate-datasets"> </a></h2><p>For small dataset, we can keep the simulated data sets in the tracking dataframe. If the simulated dataset is large, we only keep the sample statistics in the dataframe.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">simulate_data_seq</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>

    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">sim_data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sim_data_seq</span> <span class="o">=</span> <span class="n">simulate_data_seq</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 1.34 s, sys: 177 ms, total: 1.51 s
Wall time: 1.52 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Do-stuff-with-the-simulated-datasets">Do stuff with the simulated datasets<a class="anchor-link" href="#Do-stuff-with-the-simulated-datasets"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calculate_sample_stats</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;calculate sample statistics&quot;&quot;&quot;</span>
    <span class="n">average</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p05</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">p95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="n">average</span><span class="p">,</span>
        <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">variance</span><span class="p">,</span>
        <span class="s2">&quot;p05&quot;</span><span class="p">:</span> <span class="n">p05</span><span class="p">,</span>
        <span class="s2">&quot;p95&quot;</span><span class="p">:</span> <span class="n">p95</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">compute_seq</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_sample_stats</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sample_stats_seq</span> <span class="o">=</span> <span class="n">compute_seq</span><span class="p">(</span><span class="n">sim_data_seq</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 3.32 s, sys: 12.3 ms, total: 3.34 s
Wall time: 3.34 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Keep-everything-in-a-dataframe">Keep everything in a dataframe<a class="anchor-link" href="#Keep-everything-in-a-dataframe"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">params</span><span class="p">,</span> <span class="n">sim_data_seq</span><span class="p">,</span> <span class="n">sample_stats_seq</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loc</th>
      <th>scale</th>
      <th>rep</th>
      <th>size</th>
      <th>sample</th>
      <th>average</th>
      <th>variance</th>
      <th>p05</th>
      <th>p95</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>10000</td>
      <td>[0.319077282511964, 0.18965678964333085, -0.63...</td>
      <td>-0.018138</td>
      <td>1.000294</td>
      <td>-1.665284</td>
      <td>1.624925</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>10000</td>
      <td>[1.0530038923608775, 0.6534644477062702, 1.385...</td>
      <td>-0.006782</td>
      <td>1.008830</td>
      <td>-1.632020</td>
      <td>1.693900</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>10000</td>
      <td>[0.619682511046317, 0.8076221364639493, -0.212...</td>
      <td>-0.003659</td>
      <td>0.977135</td>
      <td>-1.634407</td>
      <td>1.627604</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>10000</td>
      <td>[-0.7515129763643353, -0.8428228923508118, -0....</td>
      <td>0.007276</td>
      <td>0.994398</td>
      <td>-1.652222</td>
      <td>1.654156</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>10000</td>
      <td>[-0.3187877346174399, -0.09063484844832305, -0...</td>
      <td>0.001544</td>
      <td>1.005466</td>
      <td>-1.639467</td>
      <td>1.663695</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8995</th>
      <td>2</td>
      <td>3</td>
      <td>995</td>
      <td>10000</td>
      <td>[4.459473155059797, 7.17871505746818, 2.080059...</td>
      <td>1.981215</td>
      <td>9.112403</td>
      <td>-3.050421</td>
      <td>6.898461</td>
    </tr>
    <tr>
      <th>8996</th>
      <td>2</td>
      <td>3</td>
      <td>996</td>
      <td>10000</td>
      <td>[1.3252498963188968, -7.932355926994303, 5.374...</td>
      <td>1.984005</td>
      <td>8.874890</td>
      <td>-3.008920</td>
      <td>6.929186</td>
    </tr>
    <tr>
      <th>8997</th>
      <td>2</td>
      <td>3</td>
      <td>997</td>
      <td>10000</td>
      <td>[-5.566903275579494, 4.783448759876334, -1.454...</td>
      <td>1.999839</td>
      <td>8.816550</td>
      <td>-2.910886</td>
      <td>6.922024</td>
    </tr>
    <tr>
      <th>8998</th>
      <td>2</td>
      <td>3</td>
      <td>998</td>
      <td>10000</td>
      <td>[4.783361765266323, 0.06270761044701434, 6.484...</td>
      <td>2.014064</td>
      <td>8.844529</td>
      <td>-2.876956</td>
      <td>6.945541</td>
    </tr>
    <tr>
      <th>8999</th>
      <td>2</td>
      <td>3</td>
      <td>999</td>
      <td>10000</td>
      <td>[3.597228274125008, 1.7495518614255168, 6.9812...</td>
      <td>1.958327</td>
      <td>8.951227</td>
      <td>-2.915028</td>
      <td>6.874206</td>
    </tr>
  </tbody>
</table>
<p>9000 rows × 9 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parallel-computation">Parallel computation<a class="anchor-link" href="#Parallel-computation"> </a></h2><p>We may be able to speed up the simulation and computation using parallel computation, e.g., multiprocessing, multithreading, or other packages, depending on whether the bottlenecks are the I/O, memory, cache, or CPU.</p>
<p>Below is an example of multiprocessing. A few notes when using multiprocessing in Python.</p>
<ul>
<li>Depending on the size of the datasets, number of datasets, and how cpu-hungry the computations are, multiprocessing may not perform better than sequential processing. In my working example, multiprocessing did not improve performance. In my real simulation work with heavier computations, multiprocessing does help.</li>
<li>We need to change the simulation function a little in terms how it takes in arguments, to facilitate the <code>map</code> function.</li>
<li>Chunksize may be a factor for performance.</li>
<li><code>Numpy</code>, <code>Scipy</code>, and <code>Pandas</code> scientific computing packages may not play well with multiprocessing. Read more <a href="https://stackoverflow.com/a/15641148/3101585">here</a>.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">CHUNKSIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_cores</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">CHUNKSIZE</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1125</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">simulate_data</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span>  <span class="c1"># float</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>  <span class="c1"># float</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>  <span class="c1"># int</span>

    <span class="c1"># be sure to reseed the RNG</span>
    <span class="c1"># see discussions here: https://github.com/numpy/numpy/issues/9650</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">simulate_data_mp</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>

    <span class="n">params_list</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">simulate_data</span><span class="p">,</span> <span class="n">params_list</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">CHUNKSIZE</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">sim_data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sim_data_mp</span> <span class="o">=</span> <span class="n">simulate_data_mp</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 619 ms, sys: 4.15 s, total: 4.77 s
Wall time: 6.22 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">compute_mp</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">sample_stats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculate_sample_stats</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">],</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">CHUNKSIZE</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sample_stats_mp</span> <span class="o">=</span> <span class="n">compute_mp</span><span class="p">(</span><span class="n">sim_data_seq</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 403 ms, sys: 683 ms, total: 1.09 s
Wall time: 5.13 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

